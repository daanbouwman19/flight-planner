name: Build Windows Installer

permissions:
  contents: read

on:
  workflow_dispatch:

jobs:
  build:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build Release
        run: cargo build --release

      - name: Extract version from Cargo.toml
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "ProductVersion=$VERSION" >> $GITHUB_ENV

      - name: Create output directory
        run: mkdir dist

      - name: Build MSI Installer
        uses: ./.github/actions/build-msi
        with:
          version: ${{ env.ProductVersion }}

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v6
        with:
          name: flight-planner-installer
          path: dist/FlightPlannerSetup.msi
